{
  "name": "Workflow C - Cron Notifier (v2 - Full Tab Scan + Gemini)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            { "field": "cronExpression", "expression": "0 21,22,23 * * *" }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "Daily Check (21:00, 22:00, 23:00)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "read",
        "documentId": { "__rl": true, "mode": "id", "value": "={{ $env.MASTER_SYNC_SHEET_ID }}" },
        "sheetName": { "__rl": true, "mode": "name", "value": "Master_Sync" },
        "options": {}
      },
      "id": "sheets-get-all-users",
      "name": "Get All Users",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [450, 300],
      "credentials": { "googleSheetsOAuth2Api": { "id": "n8n-sheet-guard-master", "name": "n8n-sheet-guard-master" } }
    },
    {
      "parameters": {
        "jsCode": "// éæ¿¾æœ‰æ•ˆä½¿ç”¨è€…ï¼ˆæœ‰ Line_UID å’Œ Target_Sheet_IDsï¼‰\nconst users = $input.all();\n\nreturn users.filter(item => {\n  const user = item.json;\n  return user.Line_UID && user.Target_Sheet_IDs;\n}).map(item => {\n  const user = item.json;\n  \n  const spreadsheetIds = user.Target_Sheet_IDs.split(',').map(s => s.trim()).filter(Boolean);\n  const aliases = user.Aliases ? user.Aliases.split(',').map(s => s.trim()).filter(Boolean) : [];\n  \n  let sheetUrlsMap = {};\n  try {\n    if (user.Sheet_Urls_JSON) {\n      const parsed = JSON.parse(user.Sheet_Urls_JSON);\n      for (const s of parsed) {\n        sheetUrlsMap[s.spreadsheetId] = s;\n      }\n    }\n  } catch (e) {}\n  \n  let schemaCache = {};\n  try {\n    if (user.Sheet_Configs) {\n      schemaCache = JSON.parse(user.Sheet_Configs);\n    }\n  } catch (e) {}\n  \n  return {\n    json: {\n      userId: user.Line_UID,\n      realName: user.Real_Name,\n      aliases,\n      spreadsheetIds,\n      sheetUrlsMap,\n      schemaCache\n    }\n  };\n});"
      },
      "id": "code-filter-users",
      "name": "Filter Valid Users",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "jsCode": "// å±•é–‹æ¯å€‹ä½¿ç”¨è€…çš„æ¯å€‹ spreadsheet\nconst users = $input.all();\nconst result = [];\n\nfor (const userItem of users) {\n  const user = userItem.json;\n  \n  for (const spreadsheetId of user.spreadsheetIds) {\n    result.push({\n      json: {\n        userId: user.userId,\n        realName: user.realName,\n        aliases: user.aliases,\n        spreadsheetId,\n        sheetInfo: user.sheetUrlsMap[spreadsheetId] || { name: 'æœªå‘½åå ±è¡¨' },\n        schemaCache: user.schemaCache\n      }\n    });\n  }\n}\n\nreturn result;"
      },
      "id": "code-expand-spreadsheets",
      "name": "Expand User Spreadsheets",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheetId }}",
        "authentication": "oAuth2",
        "options": {
          "response": { "response": { "fullResponse": true } }
        }
      },
      "id": "http-get-metadata",
      "name": "Get Spreadsheet Metadata",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 300],
      "credentials": { "googleSheetsOAuth2Api": { "id": "n8n-sheet-guard-master", "name": "n8n-sheet-guard-master" } },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// æå– tabsï¼ŒåŒ Workflow B\nconst item = $input.first().json;\nconst prevData = $('Expand User Spreadsheets').first().json;\n\nif (item.error || !item.body || !item.body.sheets) {\n  return [{\n    json: {\n      error: true,\n      errorMessage: `ç„¡æ³•è®€å– Spreadsheet`,\n      ...prevData\n    }\n  }];\n}\n\nconst spreadsheetTitle = item.body.properties?.title || 'æœªå‘½åå ±è¡¨';\nconst sheets = item.body.sheets || [];\n\nconst visibleTabs = sheets.filter(sheet => {\n  const props = sheet.properties || {};\n  if (props.hidden) return false;\n  if (props.title === 'Master_Sync') return false;\n  return true;\n});\n\nreturn visibleTabs.map(sheet => {\n  const props = sheet.properties || {};\n  const tabSheetId = props.sheetId;\n  const tabName = props.title || 'Sheet1';\n  const rowCount = props.gridProperties?.rowCount || 1000;\n  const colCount = props.gridProperties?.columnCount || 26;\n  const cellCount = rowCount * colCount;\n  const needsDegradedRead = cellCount > 50000;\n  const cacheKey = `${prevData.spreadsheetId}::${tabName}`;\n  const cachedSchema = prevData.schemaCache[cacheKey] || null;\n  \n  return {\n    json: {\n      userId: prevData.userId,\n      realName: prevData.realName,\n      aliases: prevData.aliases,\n      spreadsheetId: prevData.spreadsheetId,\n      spreadsheetTitle,\n      spreadsheetUrl: `https://docs.google.com/spreadsheets/d/${prevData.spreadsheetId}`,\n      tabSheetId,\n      tabName,\n      tabUrl: `https://docs.google.com/spreadsheets/d/${prevData.spreadsheetId}/edit#gid=${tabSheetId}`,\n      rowCount,\n      colCount,\n      cellCount,\n      needsDegradedRead,\n      cacheKey,\n      cachedSchema\n    }\n  };\n});"
      },
      "id": "code-extract-tabs",
      "name": "Extract Tabs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://sheets.googleapis.com/v4/spreadsheets/{{ $json.spreadsheetId }}/values/{{ encodeURIComponent($json.tabName) }}!A1:AZ{{ $json.needsDegradedRead ? '10' : Math.min($json.rowCount, 500) }}",
        "authentication": "oAuth2",
        "options": {
          "response": { "response": { "fullResponse": true } }
        }
      },
      "id": "http-read-tab",
      "name": "Read Tab Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1450, 300],
      "credentials": { "googleSheetsOAuth2Api": { "id": "n8n-sheet-guard-master", "name": "n8n-sheet-guard-master" } },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// æº–å‚™ tab è³‡æ–™\nconst item = $input.first().json;\nconst prevData = $('Extract Tabs').first().json;\n\nconst tabData = item.body?.values || [];\n\nreturn [{\n  json: {\n    ...prevData,\n    tabData,\n    degradedRead: prevData.needsDegradedRead,\n    warning: prevData.needsDegradedRead ? 'è³‡æ–™é‡éå¤§ï¼Œå·²ä½¿ç”¨æŠ½æ¨£æƒæ' : null\n  }\n}];"
      },
      "id": "code-prepare-data",
      "name": "Prepare Tab Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "jsCode": "// è¨ˆç®— fingerprint\nconst item = $input.first().json;\nconst tabData = item.tabData || [];\n\nif (tabData.length === 0) {\n  return [{\n    json: {\n      ...item,\n      needsSchemaInference: false,\n      skipReason: 'Tab è³‡æ–™ç‚ºç©º'\n    }\n  }];\n}\n\nconst headerRow = tabData[0] || [];\nconst headerStr = headerRow.slice(0, 10).join('|');\nconst fingerprint = `hdr:v1:cols=${headerRow.length}:${headerStr}`;\n\nconst cachedSchema = item.cachedSchema;\nconst needsSchemaInference = !cachedSchema || cachedSchema.headerFingerprint !== fingerprint;\n\nreturn [{\n  json: {\n    ...item,\n    headerRow,\n    headerFingerprint: fingerprint,\n    needsSchemaInference,\n    existingSchema: cachedSchema\n  }\n}];"
      },
      "id": "code-fingerprint",
      "name": "Calculate Fingerprint",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [
            {
              "id": "check-schema",
              "leftValue": "={{ $json.needsSchemaInference }}",
              "rightValue": true,
              "operator": { "type": "boolean", "operation": "equals" }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "if-needs-schema",
      "name": "Needs Schema?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2050, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={{ $env.GEMINI_API_KEY }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": \"ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„ Google Sheet çµæ§‹åˆ†æå¸«ã€‚åˆ†æè¡¨é ­æ¬„ä½ï¼Œæ¨æ–·æ¯å€‹æ¬„ä½çš„èªæ„ç”¨é€”ã€‚\\n\\næ¬„ä½åˆ†é¡ï¼š\\n- date: æ—¥æœŸæ¬„ï¼ˆæ—¥æœŸã€Dateã€æ™‚é–“ï¼‰\\n- name: å§“åæ¬„ï¼ˆå§“åã€Nameã€è² è²¬äººã€LINE_IDã€æˆå“¡ï¼‰\\n- category: åˆ†é¡æ¬„ï¼ˆåˆ†é¡ã€é¡åˆ¥ã€Categoryï¼‰\\n- checkableHigh: å¿…å¡«æ¬„ä½ï¼Œç©ºç™½=æœªå¡«å¯«ï¼ˆé€²åº¦ã€ç‹€æ…‹ã€ç•™è¨€ã€é€£çµã€å®Œæˆã€å›å ±ã€å…§å®¹ï¼‰\\n- checkableAdvisory: é¸å¡«æ¬„ä½ï¼Œç©ºç™½åªæé†’ï¼ˆå‚™è¨»ã€Noteã€è£œå……ï¼‰\\n- ignore: å¿½ç•¥ï¼ˆåºè™Ÿã€ç·¨è™Ÿã€IDã€#ï¼‰\\n\\nè¼¸å‡ºç´” JSONï¼Œæ ¼å¼ï¼š\\n{\\\"columns\\\":[{\\\"col\\\":\\\"A\\\",\\\"header\\\":\\\"æ—¥æœŸ\\\",\\\"semantic\\\":\\\"date\\\"},{\\\"col\\\":\\\"B\\\",\\\"header\\\":\\\"å§“å\\\",\\\"semantic\\\":\\\"name\\\"}],\\\"summary\\\":{\\\"dateCol\\\":\\\"A\\\",\\\"nameCol\\\":\\\"B\\\",\\\"checkableHighCols\\\":[\\\"C\\\",\\\"D\\\"],\\\"checkableAdvisoryCols\\\":[\\\"E\\\"]}}\\n\\nTab: {{ $json.tabName }}\\nè¡¨é ­: {{ JSON.stringify($json.headerRow) }}\\n\\nè«‹åˆ†æä¸¦è¼¸å‡º JSONã€‚\"\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.1,\n    \"maxOutputTokens\": 1000\n  }\n}",
        "options": {}
      },
      "id": "gemini-schema",
      "name": "Gemini Schema Inference",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2250, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const geminiResult = $input.first().json;\nconst prevData = $('Calculate Fingerprint').first().json;\n\nlet schema = null;\ntry {\n  const content = geminiResult.candidates?.[0]?.content?.parts?.[0]?.text || '{}';\n  schema = JSON.parse(content.replace(/```json\\n?|```/g, '').trim());\n  schema.headerFingerprint = prevData.headerFingerprint;\n} catch (e) {\n  schema = {\n    columns: [],\n    summary: { dateCol: null, nameCol: null, checkableHighCols: [], checkableAdvisoryCols: [] },\n    headerFingerprint: prevData.headerFingerprint\n  };\n}\n\nreturn [{\n  json: {\n    ...prevData,\n    schema,\n    schemaSource: 'gemini-inferred'\n  }\n}];"
      },
      "id": "code-parse-schema",
      "name": "Parse Schema",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2450, 200]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nreturn [{\n  json: {\n    ...item,\n    schema: item.existingSchema,\n    schemaSource: 'cached'\n  }\n}];"
      },
      "id": "code-use-cache",
      "name": "Use Cached Schema",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2250, 400]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "id": "merge-schema",
      "name": "Merge Schema Paths",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [2650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={{ $env.GEMINI_API_KEY }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": \"ä½ æ˜¯ç²¾æº–çš„è³‡æ–™æŸ¥æ ¸å“¡ã€‚æª¢æŸ¥ Google Sheet è³‡æ–™ï¼Œåˆ¤æ–·ä½¿ç”¨è€…ä»Šæ—¥æ˜¯å¦æœ‰æœªå¡«å¯«æ¬„ä½ã€‚\\n\\næœªå¡«å¯«å®šç¾©ï¼šç©ºç™½ã€NAã€N/Aã€n/aã€å¾…å¡«ã€å¾…å¡«å¯«ã€-ã€--ã€ç´”ç©ºæ ¼\\nå·²å¡«å¯«å®šç¾©ï¼šæœ‰ä»»ä½•å¯¦è³ªå…§å®¹\\n\\næµç¨‹ï¼š\\n1. æ‰¾ã€Œæ—¥æœŸæ¬„ã€= ä»Šæ—¥çš„åˆ—\\n2. æ‰¾ã€Œå§“åæ¬„ã€èˆ‡ã€Œåˆ¥åã€åŒ¹é…çš„åˆ—\\n3. æª¢æŸ¥ checkableHigh æ¬„ä½æ˜¯å¦æœªå¡«å¯«\\n4. checkableAdvisory æ¬„ä½ç©ºç™½åªåˆ—å…¥ advisoryï¼Œä¸ç®— missing\\n\\nè¼¸å‡ºç´” JSONï¼š\\n{\\\"matchedRows\\\":[{\\\"row\\\":4,\\\"date\\\":\\\"2026/01/08\\\",\\\"name\\\":\\\"Sin\\\",\\\"missingFields\\\":[{\\\"col\\\":\\\"D\\\",\\\"header\\\":\\\"ä¸€èˆ¬ç•™è¨€\\\",\\\"cell\\\":\\\"D4\\\"}],\\\"advisoryFields\\\":[{\\\"col\\\":\\\"F\\\",\\\"header\\\":\\\"å‚™è¨»\\\",\\\"cell\\\":\\\"F4\\\"}]}],\\\"summary\\\":{\\\"status\\\":\\\"missing\\\",\\\"totalMissing\\\":1,\\\"totalAdvisory\\\":1}}\\n\\nstatus: completed(ç„¡missing) / missing(æœ‰missing) / not_found(æ‰¾ä¸åˆ°ä»Šæ—¥+åˆ¥ååŒ¹é…)\\n\\nä»Šæ—¥ï¼š{{ $now.format('YYYY/MM/DD') }}ï¼ˆä¹Ÿå¯èƒ½æ˜¯ {{ $now.format('MM/DD') }} æˆ– {{ $now.format('M/D') }} æ ¼å¼ï¼‰\\nåˆ¥åï¼š{{ $json.aliases }}\\n\\nSchemaï¼š\\n{{ JSON.stringify($json.schema?.summary || {}) }}\\n\\nè³‡æ–™ï¼ˆå‰ 500 åˆ—ï¼‰ï¼š\\n{{ JSON.stringify(($json.tabData || []).slice(0, 500)) }}\\n\\nè«‹æª¢æŸ¥ä¸¦è¼¸å‡º JSONã€‚\"\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.1,\n    \"maxOutputTokens\": 2000\n  }\n}",
        "options": {}
      },
      "id": "gemini-status",
      "name": "Gemini Status Inference",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2850, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// å»ºç«‹ reports\nconst geminiResult = $input.first().json;\nconst prevData = $('Merge Schema Paths').first().json;\n\nlet statusResult = null;\ntry {\n  const content = geminiResult.candidates?.[0]?.content?.parts?.[0]?.text || '{}';\n  statusResult = JSON.parse(content.replace(/```json\\n?|```/g, '').trim());\n} catch (e) {\n  statusResult = { matchedRows: [], summary: { status: 'error' } };\n}\n\nconst reports = [];\nconst advisories = [];\nconst today = new Date().toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' }).replace(/\\//g, '/');\n\nfor (const row of (statusResult.matchedRows || [])) {\n  for (const field of (row.missingFields || [])) {\n    reports.push({\n      headline: `${today}ï½œ${prevData.tabName}ï½œæœªå¡«ï¼š${field.header}(${field.cell})`,\n      sheetTitle: prevData.spreadsheetTitle,\n      tabName: prevData.tabName,\n      tabUrl: prevData.tabUrl,\n      missingFieldName: field.header,\n      cellRef: field.cell\n    });\n  }\n  \n  for (const field of (row.advisoryFields || [])) {\n    advisories.push({\n      tabName: prevData.tabName,\n      note: `æ¬„ä½ã€Œ${field.header}ã€è«‹è‡ªè¡Œæª¢æŸ¥`\n    });\n  }\n}\n\nreturn [{\n  json: {\n    userId: prevData.userId,\n    realName: prevData.realName,\n    spreadsheetTitle: prevData.spreadsheetTitle,\n    tabName: prevData.tabName,\n    status: statusResult.summary?.status || 'unknown',\n    reports,\n    advisories\n  }\n}];"
      },
      "id": "code-build-reports",
      "name": "Build Reports",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3050, 300]
    },
    {
      "parameters": {
        "jsCode": "// æŒ‰ä½¿ç”¨è€…å½™æ•´çµæœ\nconst allItems = $input.all();\n\n// æŒ‰ userId åˆ†çµ„\nconst userResults = {};\n\nfor (const item of allItems) {\n  const data = item.json;\n  const userId = data.userId;\n  \n  if (!userResults[userId]) {\n    userResults[userId] = {\n      userId,\n      realName: data.realName,\n      reports: [],\n      advisories: []\n    };\n  }\n  \n  if (data.reports) {\n    userResults[userId].reports.push(...data.reports);\n  }\n  if (data.advisories) {\n    userResults[userId].advisories.push(...data.advisories);\n  }\n}\n\n// åªå›å‚³æœ‰ missing çš„ä½¿ç”¨è€…\nreturn Object.values(userResults)\n  .filter(u => u.reports.length > 0)\n  .map(u => ({ json: u }));"
      },
      "id": "code-aggregate-by-user",
      "name": "Aggregate by User",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3250, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [
            {
              "id": "check-has-missing",
              "leftValue": "={{ $json.reports.length }}",
              "rightValue": 0,
              "operator": { "type": "number", "operation": "gt" }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "if-has-missing",
      "name": "Has Missing?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3450, 300]
    },
    {
      "parameters": {
        "jsCode": "// å»ºç«‹ LINE æ¨æ’­è¨Šæ¯\nconst user = $input.first().json;\n\nconst reports = user.reports || [];\nconst advisories = user.advisories || [];\n\n// å»ºç«‹è¨Šæ¯å…§å®¹\nlet message = `ğŸ“‹ ${user.realName || 'æ‚¨'}ï¼Œä»Šæ—¥æœ‰ ${reports.length} é …æœªå¡«å¯«ï¼š\\n\\n`;\n\n// æŒ‰ sheetTitle åˆ†çµ„\nconst bySheet = {};\nfor (const r of reports) {\n  const key = r.sheetTitle || 'æœªçŸ¥å ±è¡¨';\n  if (!bySheet[key]) bySheet[key] = [];\n  bySheet[key].push(r);\n}\n\nfor (const [sheetTitle, items] of Object.entries(bySheet)) {\n  message += `ğŸ“Š ${sheetTitle}\\n`;\n  for (const item of items) {\n    message += `  â€¢ ${item.tabName}ï¼š${item.missingFieldName}\\n`;\n  }\n  message += '\\n';\n}\n\n// åŠ å…¥ advisory æé†’ï¼ˆæœ€å¤š 3 æ¢ï¼‰\nif (advisories.length > 0) {\n  message += `\\nğŸ’¡ å¦æœ‰ ${advisories.length} é …é¸å¡«æ¬„ä½è«‹è‡ªè¡Œæª¢æŸ¥`;\n}\n\nmessage += `\\n\\nå‰å¾€å¡«å¯« ğŸ‘‰ https://liff.line.me/${$env.LIFF_ID || 'YOUR_LIFF_ID'}`;\n\nreturn [{\n  json: {\n    userId: user.userId,\n    message,\n    reportsCount: reports.length\n  }\n}];"
      },
      "id": "code-build-message",
      "name": "Build LINE Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.line.me/v2/bot/message/push",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Bearer {{ $env.LINE_CHANNEL_ACCESS_TOKEN }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"to\": \"{{ $json.userId }}\",\n  \"messages\": [\n    {\n      \"type\": \"text\",\n      \"text\": {{ JSON.stringify($json.message) }}\n    }\n  ]\n}",
        "options": {}
      },
      "id": "http-line-push",
      "name": "LINE Push Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3850, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// è¨˜éŒ„æ¨æ’­çµæœ\nconst result = $input.first().json;\nconst prevData = $('Build LINE Message').first().json;\n\nconsole.log(`Pushed to ${prevData.userId}: ${prevData.reportsCount} missing items`);\n\nreturn [{\n  json: {\n    userId: prevData.userId,\n    success: !result.error,\n    reportsCount: prevData.reportsCount\n  }\n}];"
      },
      "id": "code-log-result",
      "name": "Log Push Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4050, 300]
    }
  ],
  "connections": {
    "Daily Check (21:00, 22:00, 23:00)": {
      "main": [[{ "node": "Get All Users", "type": "main", "index": 0 }]]
    },
    "Get All Users": {
      "main": [[{ "node": "Filter Valid Users", "type": "main", "index": 0 }]]
    },
    "Filter Valid Users": {
      "main": [[{ "node": "Expand User Spreadsheets", "type": "main", "index": 0 }]]
    },
    "Expand User Spreadsheets": {
      "main": [[{ "node": "Get Spreadsheet Metadata", "type": "main", "index": 0 }]]
    },
    "Get Spreadsheet Metadata": {
      "main": [[{ "node": "Extract Tabs", "type": "main", "index": 0 }]]
    },
    "Extract Tabs": {
      "main": [[{ "node": "Read Tab Data", "type": "main", "index": 0 }]]
    },
    "Read Tab Data": {
      "main": [[{ "node": "Prepare Tab Data", "type": "main", "index": 0 }]]
    },
    "Prepare Tab Data": {
      "main": [[{ "node": "Calculate Fingerprint", "type": "main", "index": 0 }]]
    },
    "Calculate Fingerprint": {
      "main": [[{ "node": "Needs Schema?", "type": "main", "index": 0 }]]
    },
    "Needs Schema?": {
      "main": [
        [{ "node": "Gemini Schema Inference", "type": "main", "index": 0 }],
        [{ "node": "Use Cached Schema", "type": "main", "index": 0 }]
      ]
    },
    "Gemini Schema Inference": {
      "main": [[{ "node": "Parse Schema", "type": "main", "index": 0 }]]
    },
    "Parse Schema": {
      "main": [[{ "node": "Merge Schema Paths", "type": "main", "index": 0 }]]
    },
    "Use Cached Schema": {
      "main": [[{ "node": "Merge Schema Paths", "type": "main", "index": 1 }]]
    },
    "Merge Schema Paths": {
      "main": [[{ "node": "Gemini Status Inference", "type": "main", "index": 0 }]]
    },
    "Gemini Status Inference": {
      "main": [[{ "node": "Build Reports", "type": "main", "index": 0 }]]
    },
    "Build Reports": {
      "main": [[{ "node": "Aggregate by User", "type": "main", "index": 0 }]]
    },
    "Aggregate by User": {
      "main": [[{ "node": "Has Missing?", "type": "main", "index": 0 }]]
    },
    "Has Missing?": {
      "main": [
        [{ "node": "Build LINE Message", "type": "main", "index": 0 }],
        []
      ]
    },
    "Build LINE Message": {
      "main": [[{ "node": "LINE Push Message", "type": "main", "index": 0 }]]
    },
    "LINE Push Message": {
      "main": [[{ "node": "Log Push Result", "type": "main", "index": 0 }]]
    }
  },
  "settings": { "executionOrder": "v1" },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "pinData": {}
}
