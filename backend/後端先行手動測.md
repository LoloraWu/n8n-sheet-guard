# 後端手動測試指南

> **更新日期**: 2026-01-05
> **狀態**: Workflow 已部署到 n8n 雲端

## 已部署的 Workflows

| Workflow | n8n ID | 狀態 | Webhook Path |
|----------|--------|------|--------------|
| Workflow A - User API | `gGOGUZm4fu0yJ9kt` | Active | `user-register`, `user-profile` |
| Workflow B - Report Status API | `GiqwRZFgxV37Y2X7` | Active | `report-status` |
| Workflow C - Daily Notifier | `2Co97OMEGxJNFhAW` | Inactive | N/A (Cron 21,22,23 點) |

### n8n 雲端管理介面
- URL: https://lorawu.app.n8n.cloud
- Workflows: https://lorawu.app.n8n.cloud/workflows

---

## 重要：Webhook 啟用步驟

**透過 API 啟用的 workflow，webhook 可能不會自動註冊。請在 n8n UI 中手動操作：**

1. 開啟 https://lorawu.app.n8n.cloud/workflows
2. 點擊目標 workflow
3. 點擊右上角的 **Active** 開關（先關閉再開啟）
4. 等待幾秒後測試 webhook

---

## Webhook 測試指令

### 測試 User Profile API
```bash
curl "https://lorawu.app.n8n.cloud/webhook/user-profile?userId=test123"
```

### 測試 User Register API
```bash
curl -X POST "https://lorawu.app.n8n.cloud/webhook/user-register" \
  -H "Content-Type: application/json" \
  -d '{"userId": "U12345", "realName": "測試用戶", "aliases": ["小測"], "sheetUrls": []}'
```

### 測試 Report Status API
```bash
curl "https://lorawu.app.n8n.cloud/webhook/report-status?userId=test123"
```

---

## 目前限制（Mock 模式）

由於尚未設定 Google Sheets 和 LINE 憑證，目前 workflows 使用 Mock 資料：

1. **Workflow A**: 
   - Register: 驗證 userId 後回傳成功訊息
   - Profile: 回傳 Mock 使用者資料

2. **Workflow B**:
   - 回傳 Mock 報表狀態（2 份報表，1 完成 1 未填）

3. **Workflow C**:
   - Cron 觸發後輸出 Mock LINE 訊息（不會實際發送）

---

## 正式環境設定（待完成）

### 1. Google Sheets 憑證
1. 進入 n8n Settings > Credentials
2. 新增 Google Sheets OAuth2 API 憑證
3. 授權 Google 帳戶

### 2. 環境變數
1. 進入 n8n Settings > Variables
2. 新增 `MASTER_SYNC_SHEET_ID` = 你的 Sheet ID

### 3. LINE Messaging API 憑證
1. 新增 HTTP Header Auth 憑證
2. Header Name: `Authorization`
3. Header Value: `Bearer <YOUR_CHANNEL_ACCESS_TOKEN>`

### 4. OpenAI 憑證
1. 新增 OpenAI API 憑證
2. 輸入 API Key

---

## 檔案說明

```
backend/
├── workflow-a-user-api.json      # 使用者 API (已部署)
├── workflow-b-report-api.json    # 報表狀態 API (已部署)  
├── workflow-c-cron-notifier.json # 定時推播 (已部署)
├── workflow-health-check.json    # 健康檢查
├── test-workflow-a.json          # 本地測試版
├── test-workflow-b.json          # 本地測試版
├── test-workflow-c.json          # 本地測試版
└── 後端先行手動測.md              # 本文件
```
